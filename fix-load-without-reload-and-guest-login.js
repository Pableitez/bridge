// ===== FIX LOAD WITHOUT RELOAD AND GUEST LOGIN =====

// Funci√≥n para arreglar la carga sin reload y evitar login en guest mode
function fixLoadWithoutReloadAndGuestLogin() {
    console.log('üîß Fixing load without reload and guest login issues...');
    
    // 1. Arreglar la funci√≥n applyConfigurationFromFile para no hacer reload
    function fixApplyConfigurationFromFile() {
        console.log('üîÑ Fixing applyConfigurationFromFile to avoid page reload...');
        
        // Override la funci√≥n applyConfigurationFromFile
        window.applyConfigurationFromFile = async function(config) {
            console.log('üîÑ Applying configuration from file (NO RELOAD)...');
            
            try {
                // Aplicar configuraci√≥n de filtros
                if (config.filters) {
                    localStorage.setItem('thebridge_filters', JSON.stringify(config.filters));
                }
                
                if (config.quickFilters) {
                    localStorage.setItem('quickFilters', JSON.stringify(config.quickFilters));
                }
                
                // Aplicar configuraci√≥n de vistas de tabla
                if (config.tableViews) {
                    localStorage.setItem('tableViews', JSON.stringify(config.tableViews));
                }
                
                if (config.currentTableView) {
                    localStorage.setItem('thebridge_current_table_view', config.currentTableView);
                }
                
                // Aplicar configuraci√≥n de columnas
                if (config.columnConfig) {
                    localStorage.setItem('thebridge_column_config', JSON.stringify(config.columnConfig));
                }
                
                if (config.visibleColumns) {
                    localStorage.setItem('thebridge_visible_columns', JSON.stringify(config.visibleColumns));
                }
                
                if (config.columnOrder) {
                    localStorage.setItem('thebridge_column_order', JSON.stringify(config.columnOrder));
                }
                
                // Aplicar configuraci√≥n de res√∫menes personalizados
                if (config.customSummaries) {
                    localStorage.setItem('customSummaries', JSON.stringify(config.customSummaries));
                }
                
                // Aplicar favoritos
                if (config.favorites) {
                    localStorage.setItem('thebridge_favorites', JSON.stringify(config.favorites));
                }
                
                // Aplicar configuraci√≥n de tema y idioma
                if (config.theme) {
                    localStorage.setItem('thebridge_theme', config.theme);
                }
                
                if (config.language) {
                    localStorage.setItem('thebridge_language', config.language);
                }
                
                // Aplicar configuraci√≥n de auto-save
                if (config.autoSave !== undefined) {
                    window.autoSaveEnabled = config.autoSave;
                    localStorage.setItem('thebridge_auto_save', JSON.stringify(config.autoSave));
                }
                
                // Aplicar configuraci√≥n de backend
                if (config.backendUrl) {
                    window.backendUrl = config.backendUrl;
                    localStorage.setItem('thebridge_backend_url', config.backendUrl);
                }
                
                console.log('‚úÖ Configuration applied successfully');
                
                // Aplicar cambios din√°micamente sin recargar la p√°gina
                try {
                    // Aplicar tema si cambi√≥
                    if (config.theme && typeof applyTheme === 'function') {
                        applyTheme(config.theme);
                    }
                    
                    // Aplicar idioma si cambi√≥
                    if (config.language && typeof applyLanguage === 'function') {
                        applyLanguage(config.language);
                    }
                    
                    // Recargar filtros si existen
                    if (config.filters && typeof loadFilters === 'function') {
                        loadFilters();
                    }
                    
                    // Recargar vistas de tabla si existen
                    if (config.tableViews && typeof loadTableViews === 'function') {
                        loadTableViews();
                    }
                    
                    // Recargar columnas si existen
                    if (config.columnConfig && typeof applyColumnConfiguration === 'function') {
                        applyColumnConfiguration(config.columnConfig);
                    }
                    
                    // Recargar res√∫menes si existen
                    if (config.customSummaries && typeof loadCustomSummaries === 'function') {
                        loadCustomSummaries();
                    }
                    
                    // Recargar favoritos si existen
                    if (config.favorites && typeof loadFavorites === 'function') {
                        loadFavorites();
                    }
                    
                    // Recargar equipos si existen
                    if (config.teams && typeof loadTeams === 'function') {
                        loadTeams();
                    }
                    
                    // Recargar equipo actual si existe
                    if (config.currentTeam && typeof setCurrentTeam === 'function') {
                        setCurrentTeam(config.currentTeam);
                    }
                    
                    console.log('‚úÖ All configuration changes applied without page reload');
                    
                    // Mostrar notificaci√≥n de √©xito
                    if (typeof showNotification === 'function') {
                        showNotification('Configuration loaded successfully! All changes applied.', 'success');
                    } else {
                        alert('‚úÖ Configuration loaded successfully! All changes applied.');
                    }
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Some configuration changes may require manual refresh:', error);
                    
                    // Mostrar notificaci√≥n con opci√≥n de recarga manual
                    if (typeof showNotification === 'function') {
                        showNotification('Configuration loaded! Some changes may require manual refresh.', 'info');
                    } else {
                        alert('‚úÖ Configuration loaded! Some changes may require manual refresh.');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error applying configuration:', error);
                throw error;
            }
        };
        
        console.log('‚úÖ applyConfigurationFromFile fixed to avoid page reload');
    }
    
    // 2. Evitar que aparezca el modal de login en guest mode
    function fixGuestModeLoginModal() {
        console.log('üë§ Fixing guest mode login modal...');
        
        // Override showLoginRegisterModal para guest mode
        const originalShowLoginRegisterModal = window.showLoginRegisterModal;
        if (originalShowLoginRegisterModal) {
            window.showLoginRegisterModal = function() {
                console.log('üîß Enhanced showLoginRegisterModal - checking guest mode...');
                
                // Verificar si estamos en guest mode
                const isGuestMode = !window.currentUser || 
                                   (window.currentUser && window.currentUser.role === 'guest') ||
                                   !localStorage.getItem('thebridge_current_user');
                
                if (isGuestMode) {
                    console.log('üë§ Guest mode detected - showing User Setup directly');
                    
                    // En guest mode, mostrar User Setup directamente
                    if (window.showUserSetUpModal) {
                        window.showUserSetUpModal();
                    } else {
                        // Fallback: buscar y mostrar el modal manualmente
                        const userSetupModal = document.getElementById('userSetUpModal');
                        if (userSetupModal) {
                            userSetupModal.classList.remove('hidden');
                        }
                    }
                } else {
                    console.log('üë§ Registered user mode - showing login modal');
                    // Para usuarios registrados, mostrar el modal normal
                    originalShowLoginRegisterModal.call(this);
                }
            };
        }
        
        // Tambi√©n arreglar el bot√≥n User Setup para guest mode
        const userSetUpBtn = document.getElementById('userSetUpBtn');
        if (userSetUpBtn) {
            const originalClick = userSetUpBtn.onclick;
            userSetUpBtn.onclick = function(e) {
                console.log('üîß User Setup button clicked - checking guest mode...');
                
                // Verificar si estamos en guest mode
                const isGuestMode = !window.currentUser || 
                                   (window.currentUser && window.currentUser.role === 'guest') ||
                                   !localStorage.getItem('thebridge_current_user');
                
                if (isGuestMode) {
                    console.log('üë§ Guest mode - showing User Setup directly');
                    // En guest mode, mostrar User Setup directamente
                    if (window.showUserSetUpModal) {
                        window.showUserSetUpModal();
                    } else {
                        // Fallback: mostrar modal manualmente
                        const userSetupModal = document.getElementById('userSetUpModal');
                        if (userSetupModal) {
                            userSetupModal.classList.remove('hidden');
                        }
                    }
                } else {
                    console.log('üë§ Registered user - showing login modal');
                    // Para usuarios registrados, mostrar el modal normal
                    if (originalClick) {
                        originalClick.call(this, e);
                    } else {
                        if (window.showLoginRegisterModal) {
                            window.showLoginRegisterModal();
                        }
                    }
                }
            };
        }
        
        console.log('‚úÖ Guest mode login modal fixed');
    }
    
    // 3. Aplicar todos los fixes
    function applyAllFixes() {
        console.log('üîß Applying all load and guest fixes...');
        
        // Aplicar fixes inmediatamente
        fixApplyConfigurationFromFile();
        fixGuestModeLoginModal();
        
        // Tambi√©n aplicar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    fixApplyConfigurationFromFile();
                    fixGuestModeLoginModal();
                }, 1000);
            });
        } else {
            setTimeout(() => {
                fixApplyConfigurationFromFile();
                fixGuestModeLoginModal();
            }, 1000);
        }
        
        console.log('‚úÖ All load and guest fixes applied');
    }
    
    // Aplicar todos los fixes
    applyAllFixes();
}

// Exportar la funci√≥n para uso global
window.fixLoadWithoutReloadAndGuestLogin = fixLoadWithoutReloadAndGuestLogin;

// Aplicar el fix autom√°ticamente
fixLoadWithoutReloadAndGuestLogin();

console.log('üîß Load without reload and guest login fix script loaded and applied'); 